<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gap Filler - Home</title>
  <link rel="stylesheet" href="styles.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">

  <style>
    .time-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 16px;
      justify-items: stretch;
      align-content: flex-start;
      border: 1px solid #e0e0e0;
      background: white;
      width: 650px;
      height: 450px;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    .time-slot {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
    }

    /* Hide native radio */
    .time-slot input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Pill look for all labels (including custom) */
    .time-slot label {
      display: block;
      width: 100%;
      padding: 10px 8px;
      border-radius: 999px;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 500;
      background-color: #ffffff;
      border: 1px solid #d0d7de;
      color: #333 !important;
      cursor: pointer;
      transition:
        background-color 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.1s ease;
    }

    .time-slot label:hover {
      background-color: #f0f7ff;
      transform: translateY(-1px) scale(1.05);
    }

    body.dark-mode .time-slot label:hover{
      background-color: #b7bdc2;
      border-color: #b7bdc2;
    }

    /* Selected pill (normal + custom) */
    .time-slot input[type="radio"]:checked + label {
      background-color: #006eb5;
      color: black;
      border-color: #005493;
      box-shadow: 0 4px 10px rgba(0, 110, 181, 0.35);
      transform: translateY(-1px) scale(1.1);
    }

    /* Custom time row spans full width */
    .custom-time-slot {
      grid-column: 1 / -1;
      border-top: 1px solid #e0e0e0;
      padding-top: 12px;
      margin-top: 4px;
    }

    .custom-time-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 6px;
    }

    .custom-time-slot select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d0d7de;
      background-color: #ffffff;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .custom-time-slot select:focus {
      outline: none;
      border-color: #006eb5;
      box-shadow: 0 0 0 2px rgba(0, 110, 181, 0.2);
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    .profile-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      background-color: white;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      overflow: hidden;
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 10px 15px;
      text-decoration: none;
      color: #333;
    }

    .dropdown-item:hover {
      background-color: #f0f0f0;
    }

    .time-wrapper {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    /* Right-side chosen times panel */
    .chosen-times {
      margin-top: 0;
      width: 355px;
      height: 450px;
      border: 1px solid #d0d7de;
      background: #ffffff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
      font-family: inherit;
    }

    .chosen-times h3 {
      margin-top: 0;
      font-size: 1.1rem;
      text-align: center;
      color: #333;
    }

    .chosen-limit {
      margin: 0 0 8px;
      font-size: 0.85rem;
      text-align: center;
      color: #666;
    }

    .no-selected {
      text-align: center;
      font-size: 0.9rem;
      color: rgba(0, 0, 0, 0.5);
      padding-top: 8px;
    }

    .selected-pill {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 999px;
      background: #006eb5;
      color: white;
      cursor: pointer;
      text-align: center;
      border: 1px solid #005493;
      transition: opacity 0.15s ease;
    }

    .selected-pill:hover {
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <a href="index.html" class="logo-link">
        <div class="logo">Gap Filler</div>
      </a>

      <ul class="header-nav">
        <li class="header-nav-item"><a href="index.html">Home</a></li>
        <li class="header-nav-item"><a href="allEvents.html">All Events</a></li>
        <li class="header-nav-item"><a href="addEvent.html">Add Event</a></li>
        <li class="header-nav-item"><a href="pastEvents.html">View Past Events</a></li>
      </ul>

      <div class="header-icons">
        <div class="theme-toggle">
          <input type="checkbox" id="theme-switch" class="theme-switch-input">
          <label for="theme-switch" class="theme-switch-label">
            <span class="theme-icon sun">‚òÄÔ∏è</span>
            <span class="theme-icon moon">üåô</span>
          </label>
        </div>
        <div class="profile-dropdown">
          <button class="icon profile-icon" id="profileButton">
            üë§
          </button>
          <div class="dropdown-menu" id="dropdownMenu">
            <a href="index.html" class="dropdown-item">Logout</a>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="breadcrumb-container" id="breadcrumbs">
      </div>

      <div class="questionnaire-container">
        <div class="progress-indicator">
          <div class="progress-circle active" onclick="window.location.href='q1.html'">
            1
          </div>
          <div class="progress-circle" onclick="window.location.href='q2.html'">
            2
          </div>
          <div class="progress-circle" onclick="window.location.href='q3.html'">
            3
          </div>
          <div class="progress-circle" onclick="window.location.href='q4.html'">
            4
          </div>
        </div>

        <h1 class="question-title">When are you free?</h1>

        <div class="time-wrapper">
          <form id="timeForm">
            <div class="time-selection" id="timeSelection"></div>
          </form>

          <div class="chosen-times" id="chosenTimes">
            <h3>Selected Times</h3>
            <p class="chosen-limit">(Limit 4)</p>
            <div id="chosenList">
              <div id="noSelectedPlaceholder" class="no-selected">No Selected Times</div>
            </div>
          </div>
        </div>

        <div class="nav-buttons">
          <button class="btn-nav btn-previous" onclick="window.location.href='index.html'">
            Home
          </button>
          <button class="btn-nav btn-next" onclick="window.location.href='q2.html'">
            Next
          </button>
        </div>
      </div>
    </main>

    <footer class="footer">
      <div class="footer-note">
        2025 Gap Filler | COMP 3020 Project Prototype (Group 9)
      </div>
    </footer>
  </div>

  <script>
    const container = document.getElementById("timeSelection");

    function toDisplayLabel(hours24, minutes) {
      let displayHours = ((hours24 + 11) % 12) + 1;
      let ampm = hours24 >= 12 ? "PM" : "AM";
      return `${displayHours}:${minutes.toString().padStart(2, "0")} ${ampm}`;
    }

    // 8:00 AM to 5:30 PM in 30-minute steps
    const startMinutes = 8 * 60;
    const endMinutes = 17 * 60 + 30;

    // Create standard time slots
    for (let i = startMinutes; i <= endMinutes; i += 30) {
      let hours = Math.floor(i / 60);
      let minutes = i % 60;
      let label = toDisplayLabel(hours, minutes);

      const div = document.createElement("div");
      div.className = "time-slot";
      div.innerHTML = `
        <input type="radio" name="time" id="time-${i}" value="${label}">
        <label for="time-${i}">${label}</label>
      `;
      container.appendChild(div);
    }

    // Custom time row at the bottom
    const customDiv = document.createElement("div");
    customDiv.className = "time-slot custom-time-slot";
    customDiv.innerHTML = `
      <input type="radio" name="time" id="time-custom" value="">
      <label id="custom-time-pill" for="time-custom">Select Custom Time</label>
      <div class="custom-time-controls">
        <select id="custom-hour">
          ${Array.from({ length: 12 }, (_, i) => {
            const h = i + 1;
            return `<option value="${h}">${h}</option>`;
          }).join("")}
        </select>
        <span>:</span>
        <select id="custom-minute">
          ${Array.from({ length: 60 }, (_, i) => {
            const m = i.toString().padStart(2, "0");
            return `<option value="${m}">${m}</option>`;
          }).join("")}
        </select>
        <select id="custom-ampm">
          <option value="AM">AM</option>
          <option value="PM">PM</option>
        </select>
      </div>
    `;
    container.appendChild(customDiv);

    const customHour = customDiv.querySelector("#custom-hour");
    const customMinute = customDiv.querySelector("#custom-minute");
    const customAmpm = customDiv.querySelector("#custom-ampm");
    const customTimeRadio = customDiv.querySelector("#time-custom");
    const customTimePill = document.getElementById("custom-time-pill");

    // Dropdown menu logic
    const profileButton = document.getElementById("profileButton");
    const dropdownMenu = document.getElementById("dropdownMenu");

    profileButton.addEventListener("click", function (e) {
      e.stopPropagation();
      dropdownMenu.classList.toggle("show");
    });

    document.addEventListener("click", function (e) {
      if (
        !profileButton.contains(e.target) &&
        !dropdownMenu.contains(e.target)
      ) {
        dropdownMenu.classList.remove("show");
      }
    });

    // Dark Mode Toggle
    const themeSwitch = document.getElementById('theme-switch');

    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeSwitch.checked = true;
    } else {
      document.body.classList.remove('dark-mode');
      themeSwitch.checked = false;
    }
    themeSwitch.addEventListener('change', function () {
      if (this.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
      }
    });

    function renderBreadcrumbs() {
      const breadcrumbs = document.getElementById('breadcrumbs');
      if (breadcrumbs) {
        breadcrumbs.innerHTML = `
            <a href="index.html" class="breadcrumb-link">Home</a>
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">Questionnaire</span>`;
      }
    }
    renderBreadcrumbs();

    //---------------------------------------------------------------
    // MOVE SELECTED TIMES FROM LEFT ‚Üí RIGHT
    // CLICKING A PILL REMOVES IT
    // LIMIT = 4 SELECTIONS
    //---------------------------------------------------------------

    const chosenList = document.getElementById("chosenList");
    const timeSelection = document.getElementById("timeSelection");
    const noSelectedPlaceholder = document.getElementById("noSelectedPlaceholder");

    function selectedCount() {
      return chosenList.querySelectorAll(".selected-pill").length;
    }

    function updateNoSelectedPlaceholder() {
      if (selectedCount() === 0) {
        noSelectedPlaceholder.style.display = "block";
      } else {
        noSelectedPlaceholder.style.display = "none";
      }
    }

    // Flash red border on chosen-times box without getting stuck
    let redFlashTimeout = null;
    function flashRedBox() {
      const chosenBox = document.getElementById("chosenTimes");

      if (redFlashTimeout) {
        clearTimeout(redFlashTimeout);
      }

      chosenBox.style.borderColor = "red";

      redFlashTimeout = setTimeout(() => {
        chosenBox.style.borderColor = "#d0d7de";
        redFlashTimeout = null;
      }, 800);
    }

    // Convert "8:30 AM" -> minutes since midnight
    function convertLabelToMinutes(label) {
      const [time, ampm] = label.split(" ");
      if (!time || !ampm) return 0; // safety for weird values
      let [hour, minute] = time.split(":").map(Number);

      if (ampm === "PM" && hour !== 12) hour += 12;
      if (ampm === "AM" && hour === 12) hour = 0;

      return hour * 60 + minute;
    }

    function sortChosenList() {
      const pills = Array.from(chosenList.querySelectorAll(".selected-pill"));

      const parsed = pills.map(p => {
        const label = p.textContent.trim();
        const minutes = convertLabelToMinutes(label);
        return { element: p, minutes };
      });

      parsed.sort((a, b) => a.minutes - b.minutes);
      parsed.forEach(item => chosenList.appendChild(item.element));
    }

    function saveChosenTimes() {
      const labels = Array.from(
        chosenList.querySelectorAll(".selected-pill")
      ).map(p => p.textContent.trim());

      localStorage.setItem("chosenTimes", JSON.stringify(labels));
    }

    // Create or update a pill in the right panel
    function moveTimeToChosen(id, label) {
      let pill = chosenList.querySelector(`.selected-pill[data-id="${id}"]`);
      if (!pill) {
        pill = document.createElement("div");
        pill.className = "selected-pill";
        pill.dataset.id = id;
        chosenList.appendChild(pill);
      }

      pill.textContent = label;

      sortChosenList();
      saveChosenTimes();
      updateNoSelectedPlaceholder();
    }

    // Restore saved selections from localStorage (by label)
    function restoreChosenTimes() {
      const saved = JSON.parse(localStorage.getItem("chosenTimes") || "[]");
      if (!saved.length) {
        updateNoSelectedPlaceholder();
        return;
      }

      saved.forEach(label => {
        // Try to match a preset time
        const radio = Array.from(
          timeSelection.querySelectorAll('input[name="time"]')
        ).find(r => r.value === label && r.id !== "time-custom");

        if (radio) {
          moveTimeToChosen(radio.id, label);
        } else {
          // Treat as a custom time
          customTimeRadio.value = label;
          customTimePill.textContent = `Custom Selected: ${label}`;
          moveTimeToChosen("time-custom", label);

          // Optional: parse label back into dropdowns
          const [time, ampm] = label.split(" ");
          if (time && ampm) {
            let [h, m] = time.split(":");
            customHour.value = String(((+h - 1 + 12) % 12) + 1); // convert back to 1‚Äì12
            customMinute.value = m;
            customAmpm.value = ampm;
          }
        }
      });

      sortChosenList();
      updateNoSelectedPlaceholder();
    }

    // Custom time: keep radio + pill synced
    function updateCustomTime(forceAddToChosen = false) {
      const hour = customHour.value;
      const minute = customMinute.value;
      const ampm = customAmpm.value;

      if (!hour || !minute || !ampm) return;

      const formattedMinute = minute.toString().padStart(2, "0");
      const label = `${hour}:${formattedMinute} ${ampm}`;

      // Always update the radio's value
      customTimeRadio.value = label;

      // ONLY update the left pill text & check radio if the user explicitly selected custom
      if (forceAddToChosen) {
        customTimePill.textContent = `Custom Selected: ${label}`;
        customTimeRadio.checked = true;
      }

      // Check if custom is already in the right-selected list
      const existingPill = chosenList.querySelector('.selected-pill[data-id="time-custom"]');

      // If already chosen OR explicitly selected, update/add the right pill
      if (existingPill || forceAddToChosen) {
        if (!existingPill && selectedCount() >= 4) return;
        moveTimeToChosen("time-custom", label);
      }
    }

    // When you click a time on the left
    timeSelection.addEventListener("change", e => {
      if (e.target.name !== "time") return;

      const radio = e.target;

      // CUSTOM TIME SELECTED
      if (radio.id === "time-custom") {
        const existingPill = !!chosenList.querySelector('.selected-pill[data-id="time-custom"]');

        // If custom is NOT already selected and we're at the limit, block and flash red
        if (!existingPill && selectedCount() >= 4) {
          radio.checked = false;
          flashRedBox();
          return; // do NOT change text to "Custom Selected"
        }

        // Build label from dropdowns and make sure it shows on the right
        updateCustomTime(true);
        return;
      }

      // PRESET TIME SELECTED
      const alreadyChosen = !!chosenList.querySelector(`.selected-pill[data-id="${radio.id}"]`);

      if (!alreadyChosen && selectedCount() >= 4) {
        // Limit reached ‚Üí block adding new selection
        radio.checked = false;
        flashRedBox();
        return;
      }

      moveTimeToChosen(radio.id, radio.value);
    });

    // Clicking a pill on the right removes it
    chosenList.addEventListener("click", e => {
      if (!e.target.classList.contains("selected-pill")) return;

      const id = e.target.dataset.id;

      e.target.remove();
      saveChosenTimes();
      updateNoSelectedPlaceholder();

      if (id === "time-custom") {
        // Clear custom selection + reset label
        customTimeRadio.checked = false;
        customTimeRadio.value = "";
        customTimePill.textContent = "Select Custom Time";
        return;
      }

      const radio = document.getElementById(id);
      if (radio) radio.checked = false;
    });

    // Custom dropdowns: changing the time should NOT auto-select or change text;
    // it only updates the value and (if custom is already chosen) its pill.
    customHour.addEventListener("change", () => updateCustomTime(false));
    customMinute.addEventListener("change", () => updateCustomTime(false));
    customAmpm.addEventListener("change", () => updateCustomTime(false));

    // Initial restore from localStorage
    restoreChosenTimes();
    updateNoSelectedPlaceholder();
  </script>

</body>

</html>
